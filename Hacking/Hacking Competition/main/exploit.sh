#!/bin/bash

# This script checks the presence of all flags in the hackathon machine.

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Function to check flag presence
check_flag() {
  if [ "$1" ]; then
    echo -e "${GREEN}[PASS]${NC} $2"
  else
    echo -e "${RED}[FAIL]${NC} $2"
  fi
}

echo "Checking for flags..."

# ============================
# 1. Hidden File Flag
# ============================
FLAG_FILE="/home/participant/.hidden_flag.txt"
check_flag "$(grep -q 'flag{hidden_file_found}' $FLAG_FILE && echo 'found')" "Hidden file flag"

# ============================
# 2. Environment Variable Flag
# ============================
source /home/participant/.bashrc
check_flag "$(env | grep -q 'FLAG_ENV=flag{env_variable_access}' && echo 'found')" "Environment variable flag"

# ============================
# 3. Process Inspection Flag
# ============================
check_flag "$(ps aux | grep -q '[m]yapp' && echo 'found')" "Process inspection flag"

# ============================
# 4. Web Application Flag
# ============================
check_flag "$(curl -s http://localhost:8080 | grep -q 'flag{web_app_vulnerability}' && echo 'found')" "Web app hidden flag in HTML"
check_flag "$(curl -s http://localhost:8080/admin.html | grep -q 'flag{web_app_vulnerability}' && echo 'found')" "Web app admin page flag"

# ============================
# 5. SSH Configuration Flag
# ============================
AUTHORIZED_KEYS="/home/participant/.ssh/authorized_keys"
check_flag "$(grep -q 'flag{ssh_flag}' $AUTHORIZED_KEYS && echo 'found')" "SSH configuration flag"

# ============================
# 6. Cron Job Flag (Visible in crontab only)
# ============================
check_flag "$(crontab -u participant -l | grep -q 'flag{cron_job_execution}' && echo 'found')" "Cron job flag"

# ============================
# 7. Permission-Based Flag
# ============================
FLAG_FILE_RESTRICTED="/home/participant/flag_restricted.txt"
check_flag "$(grep -q 'flag{permission_control}' $FLAG_FILE_RESTRICTED && echo 'found')" "Permission-based flag"

# ============================
# 8. Log File Flag
# ============================
check_flag "$(grep -q 'flag{log_file_inspection}' /var/log/syslog && echo 'found')" "Log file flag"

# ============================
# 9. Network Service Flag
# ============================
check_flag "$(echo '' | nc localhost 9000 | grep -q 'flag{network_service_access}' && echo 'found')" "Netcat network service flag"

# ============================
# Summary
# ============================
echo -e "\nFlag check complete."

